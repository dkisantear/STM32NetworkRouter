# ========================================
# COPY AND PASTE THIS ENTIRE BLOCK INTO PI TERMINAL
# ========================================

# Step 1: Create directory and script
mkdir -p ~/gateway-heartbeat
cd ~/gateway-heartbeat

cat > pi_heartbeat_automated.py << 'PYTHON_EOF'
#!/usr/bin/env python3
import requests
import time
import sys
import logging

API_URL = "https://blue-desert-0c2a27e1e.3.azurestaticapps.net/api/gateway-status"
GATEWAY_ID = "pi5-main"
HEARTBEAT_INTERVAL = 60

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/gateway-heartbeat.log'),
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger(__name__)

def send_heartbeat():
    payload = {"gatewayId": GATEWAY_ID, "status": "online"}
    try:
        response = requests.post(API_URL, json=payload, headers={"Content-Type": "application/json"}, timeout=10)
        response.raise_for_status()
        result = response.json()
        logger.info(f"âœ… Heartbeat sent: {result.get('status')}")
        return True
    except Exception as e:
        logger.error(f"âŒ Failed: {e}")
        return False

def main():
    logger.info("ğŸš€ Gateway Heartbeat Service Starting")
    while True:
        try:
            send_heartbeat()
            time.sleep(HEARTBEAT_INTERVAL)
        except KeyboardInterrupt:
            logger.info("ğŸ›‘ Shutting down...")
            try:
                requests.post(API_URL, json={"gatewayId": GATEWAY_ID, "status": "offline"}, timeout=5)
            except:
                pass
            break
        except Exception as e:
            logger.error(f"âŒ Error: {e}")
            time.sleep(HEARTBEAT_INTERVAL)

if __name__ == "__main__":
    main()
PYTHON_EOF

chmod +x pi_heartbeat_automated.py

# Step 2: Install requests (use apt-get for newer Pi OS)
sudo apt-get update
sudo apt-get install -y python3-requests

# Step 3: Create systemd service
sudo tee /etc/systemd/system/gateway-heartbeat.service > /dev/null << 'SERVICE_EOF'
[Unit]
Description=Gateway Heartbeat Service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
WorkingDirectory=/home/$USER/gateway-heartbeat
ExecStart=/usr/bin/python3 /home/$USER/gateway-heartbeat/pi_heartbeat_automated.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
SERVICE_EOF

# Step 4: Enable and start service
sudo systemctl daemon-reload
sudo systemctl enable gateway-heartbeat.service
sudo systemctl start gateway-heartbeat.service

# Step 5: Check status
sudo systemctl status gateway-heartbeat.service

echo ""
echo "âœ… Setup Complete!"
echo "Check dashboard: https://blue-desert-0c2a27e1e.3.azurestaticapps.net"
echo "Status should show 'Online' within 60 seconds!"

