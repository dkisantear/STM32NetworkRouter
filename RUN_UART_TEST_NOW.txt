#!/bin/bash
# Copy and paste this ENTIRE block into Pi terminal

echo "========================================"
echo "UART Test - All-in-One"
echo "========================================"

# Install pyserial
echo "1. Installing pyserial..."
python3 -c "import serial" 2>/dev/null || pip3 install pyserial --break-system-packages || sudo apt-get install -y python3-serial

# Create test script
echo "2. Creating test script..."
cat > /tmp/uart_test.py << 'EOF'
#!/usr/bin/env python3
import serial
import time
import sys

DEVICE = "/dev/serial0"
BAUD = 38400

print("="*50)
print(f"Opening {DEVICE} at {BAUD} baud...")
try:
    ser = serial.Serial(DEVICE, BAUD, timeout=1)
    print("âœ… Port opened!")
    print("Listening for STM32... (Press Ctrl+C to stop)")
    print("="*50)
    count = 0
    while True:
        line = ser.readline().decode("utf-8", errors="ignore").strip()
        if line:
            count += 1
            print(f"[{time.strftime('%H:%M:%S')}] #{count}: {repr(line)}")
            if line == "STM32_ALIVE":
                print("   âœ… Correct!")
except KeyboardInterrupt:
    print(f"\nðŸ›‘ Stopped after {count} messages")
except Exception as e:
    print(f"âŒ Error: {e}")
    print("Try: ls -l /dev/serial0")
finally:
    if 'ser' in locals():
        ser.close()
EOF

# Check UART device
echo "3. Checking UART device..."
ls -l /dev/serial0 2>/dev/null || echo "âš ï¸  /dev/serial0 not found, trying /dev/ttyAMA0..." && ls -l /dev/ttyAMA0 2>/dev/null

# Run test
echo ""
echo "4. Starting test..."
echo "========================================"
python3 /tmp/uart_test.py

