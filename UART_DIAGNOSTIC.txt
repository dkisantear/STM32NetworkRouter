# ========================================
# UART Diagnostic & Troubleshooting
# Copy/paste sections into Pi terminal
# ========================================

echo "========================================"
echo "1. Check UART Device & Permissions"
echo "========================================"
ls -l /dev/serial* /dev/ttyAMA* 2>/dev/null | grep -E "(serial|ttyAMA)"
echo ""
echo "Current user groups:"
groups | grep -E "(dialout|tty)"
echo ""

echo "========================================"
echo "2. Check UART Configuration"
echo "========================================"
cat /boot/firmware/config.txt 2>/dev/null | grep -i uart || cat /boot/config.txt | grep -i uart
echo ""

echo "========================================"
echo "3. Test UART Hardware (Loopback)"
echo "========================================"
echo "This will send data and try to read it back"
echo "NOTE: Connect Pi TX to Pi RX for loopback test"
echo ""
cat > /tmp/uart_loopback_test.py << 'EOF'
#!/usr/bin/env python3
import serial
import time

DEVICE = "/dev/serial0"
BAUD = 38400

try:
    ser = serial.Serial(DEVICE, BAUD, timeout=1)
    print(f"âœ… Opened {DEVICE}")
    
    # Send test message
    test_msg = b"TEST_LOOPBACK\n"
    ser.write(test_msg)
    print(f"ðŸ“¤ Sent: {test_msg.decode()}")
    
    time.sleep(0.1)
    
    # Try to read back
    if ser.in_waiting:
        received = ser.read(ser.in_waiting)
        print(f"ðŸ“¥ Received: {received}")
    else:
        print("âš ï¸  No data received (expected if not in loopback)")
    
    ser.close()
except Exception as e:
    print(f"âŒ Error: {e}")
EOF

python3 /tmp/uart_loopback_test.py
echo ""

echo "========================================"
echo "4. Send Test Data FROM Pi TO STM32"
echo "========================================"
echo "This helps verify wiring in reverse direction"
cat > /tmp/uart_send_test.py << 'EOF'
#!/usr/bin/env python3
import serial
import time

DEVICE = "/dev/serial0"
BAUD = 38400

try:
    ser = serial.Serial(DEVICE, BAUD, timeout=1)
    print(f"âœ… Opened {DEVICE} for sending")
    
    for i in range(5):
        msg = f"PI_TEST_{i}\n"
        ser.write(msg.encode())
        print(f"ðŸ“¤ Sent: {msg.strip()}")
        time.sleep(1)
    
    ser.close()
    print("âœ… Sent 5 test messages")
except Exception as e:
    print(f"âŒ Error: {e}")
EOF

python3 /tmp/uart_send_test.py
echo ""

echo "========================================"
echo "5. Try Alternative UART Device"
echo "========================================"
echo "If /dev/serial0 doesn't work, try /dev/ttyAMA0"
cat > /tmp/uart_test_alt.py << 'EOF'
#!/usr/bin/env python3
import serial
import time
import sys

for device in ["/dev/serial0", "/dev/ttyAMA0"]:
    print(f"\nðŸ” Trying {device}...")
    try:
        ser = serial.Serial(device, 38400, timeout=1)
        print(f"âœ… Successfully opened {device}")
        print("ðŸ‘‚ Listening for 5 seconds...")
        
        start = time.time()
        while time.time() - start < 5:
            if ser.in_waiting:
                line = ser.readline().decode("utf-8", errors="ignore").strip()
                if line:
                    print(f"ðŸ“¥ Received: {repr(line)}")
            time.sleep(0.1)
        
        ser.close()
        break
    except Exception as e:
        print(f"âŒ Failed: {e}")
EOF

python3 /tmp/uart_test_alt.py

