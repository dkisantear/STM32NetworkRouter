# ========================================
# FIX NOW - Copy and paste this ENTIRE block into Pi terminal
# ========================================

# Stop broken service
sudo systemctl stop gateway-heartbeat.service 2>/dev/null
sudo systemctl disable gateway-heartbeat.service 2>/dev/null

# Get your actual username
CURRENT_USER=$(whoami)
HOME_DIR=$HOME

echo "========================================"
echo "Fixing for user: $CURRENT_USER"
echo "Home: $HOME_DIR"
echo "========================================"

# Install requests library (handles newer Pi OS)
echo ""
echo "Installing requests library..."
python3 -c "import requests" 2>/dev/null || pip3 install requests --break-system-packages || sudo apt-get install -y python3-requests

# Update script with fixed log path
cd ~/gateway-heartbeat
cat > pi_heartbeat_automated.py << 'PYTHON_EOF'
#!/usr/bin/env python3
import requests
import time
import sys
import logging
import os

API_URL = "https://blue-desert-0c2a27e1e.3.azurestaticapps.net/api/gateway-status"
GATEWAY_ID = "pi5-main"
HEARTBEAT_INTERVAL = 60

# Use home directory for log (no sudo needed)
LOG_FILE = os.path.expanduser("~/gateway-heartbeat.log")

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger(__name__)

def send_heartbeat():
    payload = {"gatewayId": GATEWAY_ID, "status": "online"}
    try:
        response = requests.post(API_URL, json=payload, headers={"Content-Type": "application/json"}, timeout=10)
        response.raise_for_status()
        result = response.json()
        logger.info(f"âœ… Heartbeat sent: {result.get('status')}")
        return True
    except Exception as e:
        logger.error(f"âŒ Failed: {e}")
        return False

def main():
    logger.info("ğŸš€ Gateway Heartbeat Service Starting")
    while True:
        try:
            send_heartbeat()
            time.sleep(HEARTBEAT_INTERVAL)
        except KeyboardInterrupt:
            logger.info("ğŸ›‘ Shutting down...")
            try:
                requests.post(API_URL, json={"gatewayId": GATEWAY_ID, "status": "offline"}, timeout=5)
            except:
                pass
            break
        except Exception as e:
            logger.error(f"âŒ Error: {e}")
            time.sleep(HEARTBEAT_INTERVAL)

if __name__ == "__main__":
    main()
PYTHON_EOF

chmod +x pi_heartbeat_automated.py
echo "âœ… Script updated"

# Fix service file with correct user
echo ""
echo "Updating service file..."
sudo tee /etc/systemd/system/gateway-heartbeat.service > /dev/null << SERVICE_EOF
[Unit]
Description=Gateway Heartbeat Service
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=$CURRENT_USER
WorkingDirectory=$HOME_DIR/gateway-heartbeat
ExecStart=/usr/bin/python3 $HOME_DIR/gateway-heartbeat/pi_heartbeat_automated.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
SERVICE_EOF

echo "âœ… Service file updated"

# Restart service
echo ""
echo "Starting service..."
sudo systemctl daemon-reload
sudo systemctl enable gateway-heartbeat.service
sudo systemctl start gateway-heartbeat.service

# Wait and check
sleep 3
echo ""
echo "========================================"
echo "Service Status:"
echo "========================================"
sudo systemctl status gateway-heartbeat.service --no-pager -l

echo ""
echo "========================================"
echo "âœ… Fix Complete!"
echo "========================================"
echo ""
echo "ğŸ“‹ Check logs:"
echo "   tail -f ~/gateway-heartbeat.log"
echo ""
echo "ğŸ“‹ Or systemd logs:"
echo "   sudo journalctl -u gateway-heartbeat.service -f"
echo ""
echo "ğŸŒ Dashboard:"
echo "   https://blue-desert-0c2a27e1e.3.azurestaticapps.net"
echo ""
echo "   Status should show 'Online' within 60 seconds!"
echo ""

